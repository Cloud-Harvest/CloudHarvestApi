report:
  description: Displays the data collection jobs and their status.
  headers:
    - Id
    - Name
    - Description
    - Status
    - Records
    - Duration
    - Start
    - End

  tasks:
    # Data retrieval tasks
    - redis:
        name: Get Enqueued tasks
        description: Displays the status of the tasks that are currently awaiting processing.
        result_as: harvest_task_queue
        silo: harvest-task-queue
        command: get
        arguments:
          patterns: "task::*"
        serialization: true

    - redis:
        name: Get Active tasks
        description: Displays the status of the tasks that are currently being processed.
        result_as: harvest_tasks
        silo: harvest-tasks
        command: get
        arguments:
          patterns: "task::*"
        serialization: true

    - redis:
        name: Get Completed tasks
        description: Displays the status of the tasks that have been completed.
        result_as: harvest_task_results
        silo: harvest-task-results
        command: get
        arguments:
          patterns: "*"
          keys: "meta"
        serialization: true

    # Data formatting tasks
    - recordset:
        name: Modify enqueued task data
        description: Formats the data from the enqueued tasks.
        data: var.harvest_task_queue
        result_as: harvest_task_queue
        stages:
          - assign_value_to_key:
              key: Stage
              value: enqueued
              clobber: true
          - substring:
              source_key: _id
              # task::
              start: 6

    - recordset:
        name: Modify processing task data
        description: Formats the data from the processing tasks.
        data: var.harvest_tasks
        result_as: harvest_tasks
        stages:
          - assign_value_to_key:
              key: Stage
              value: processing
              clobber: true
          - substring:
              source_key: _id
              start: 6

    - recordset:
        name: Modify completed task data
        description: Formats the data from the completed tasks.
        data: var.harvest_task_results
        result_as: harvest_task_results
        stages:
          - assign_value_to_key:
              key: Stage
              value: completed
              clobber: true
          - unwind:
              source_key: meta
          - set_match_set:
              syntax: 'Position==Total'
          - remove_unmatched_records:
          - clear_matches:

    - recordset:
        name: Consolidate data
        description: Combines the data from the enqueued, active, and completed tasks.
        result_as: harvest_jobs
        stages:
          - add:
              data: var.harvest_task_queue

          - add:
              data: var.harvest_tasks

          - add:
              data: var.harvest_task_results

          - title_keys:
              remove_characters:
                - "_"
